<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FieldLogger Historico</title>

  <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

  <style>
    :root{
      --bg: #0b1220;
      --surface: #121a2b;
      --surface-soft: #0f1728;
      --text: #e6edf3;
      --muted: #97a3b8;
      --border: rgba(255,255,255,0.12);
      --ok: #22c55e;
      --warn: #f59e0b;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
    }

    *{ box-sizing: border-box; }

    body{
      margin:0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    a{ color: inherit; }

    button,
    select,
    input,
    textarea{
      font: inherit;
    }

    button{
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      color: var(--text);
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
      line-height:1.2;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition: background .2s ease;
    }

    button:hover{ background: rgba(255,255,255,0.10); }

    .btn-primary{
      background: var(--accent);
      border-color: var(--accent);
      color: #ffffff;
    }

    .btn-primary:hover{
      background: var(--accent-hover);
      border-color: var(--accent-hover);
    }

    .topbar{
      position:fixed;
      inset:0 0 auto 0;
      z-index:900;
      background: rgba(11, 18, 32, 0.96);
      border-bottom: 1px solid var(--border);
      display:grid;
      grid-template-columns: auto 1fr auto;
      align-items:center;
      gap:14px;
      padding:10px 20px;
      min-height:74px;
      backdrop-filter: blur(6px);
    }

    .topbar-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }

    .topbar-left h1{
      margin:0;
      font-size:18px;
      font-weight:800;
      letter-spacing:.2px;
      white-space:nowrap;
    }

    .nav-link{
      text-decoration:none;
      border: 1px solid var(--border);
      border-radius:999px;
      padding:7px 12px;
      background: rgba(255,255,255,0.05);
      font-size:12px;
      font-weight:700;
      white-space:nowrap;
    }

    .nav-link:hover{ background: rgba(255,255,255,0.10); }

    .topbar-center{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:2px;
      min-width:0;
    }

    .topbar-label{
      font-size:11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .35px;
      font-weight:700;
    }

    #periodSummary{
      font-size:13px;
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }

    .topbar-right{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
      min-width:0;
    }

    .status-chip,
    .meta-chip{
      border: 1px solid var(--border);
      border-radius:999px;
      background: rgba(255,255,255,0.03);
      font-size:11px;
      color: var(--muted);
      padding:4px 10px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      min-height:28px;
    }

    .status-chip{
      max-width:320px;
    }

    #loadStatus{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:220px;
    }

    .dot{
      width:9px;
      height:9px;
      border-radius:50%;
      background: var(--warn);
      display:inline-block;
      flex-shrink:0;
    }

    .dot.ok{ background: var(--ok); }

    .page{
      padding:90px 20px 24px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .filters-panel{
      border: 1px solid var(--border);
      border-radius:12px;
      background: var(--surface);
      overflow:hidden;
    }

    .filters-panel > summary{
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      cursor:pointer;
      font-size:14px;
      font-weight:800;
      user-select:none;
    }

    .filters-panel > summary::-webkit-details-marker{ display:none; }
    .filters-panel > summary::after{
      content: "+";
      font-size:16px;
      color: var(--muted);
      line-height:1;
    }

    .filters-panel[open] > summary::after{ content: "-"; }

    .summary-meta{
      font-size:11px;
      color: var(--muted);
      font-weight:600;
      margin-right:auto;
      margin-left:10px;
    }

    .filters-body{
      border-top: 1px solid var(--border);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .filters-grid{
      display:grid;
      grid-template-columns: repeat(5, minmax(150px, 1fr));
      gap:10px;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:5px;
    }

    .field span{
      font-size:11px;
      color: var(--muted);
      font-weight:700;
      text-transform: uppercase;
      letter-spacing:.35px;
    }

    select,
    input[type="datetime-local"],
    input[type="text"],
    textarea{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      outline:none;
      font-size:12px;
      font-weight:600;
    }

    select:disabled{
      opacity:.65;
      cursor:not-allowed;
    }

    textarea{
      resize:vertical;
      min-height:84px;
    }

    .filters-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .content-panel{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .content-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .content-header h2{
      margin:0;
      font-size:16px;
      font-weight:800;
      letter-spacing:.15px;
    }

    .content-actions{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
    }

    .column-manager-wrap{
      position:relative;
    }

    .column-manager{
      position:absolute;
      top:calc(100% + 6px);
      right:0;
      z-index:1300;
      width:min(320px, 90vw);
      max-height:340px;
      overflow:auto;
      border:1px solid var(--border);
      border-radius:12px;
      background: var(--surface-soft);
      box-shadow: 0 20px 40px rgba(0,0,0,0.45);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .column-manager[hidden]{ display:none; }

    .column-manager-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding-bottom:6px;
      border-bottom:1px solid var(--border);
    }

    .column-manager-head strong{
      font-size:12px;
      letter-spacing:.2px;
    }

    .column-manager-list{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding-right:2px;
    }

    .column-toggle{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color: var(--text);
    }

    .column-toggle input{
      width:14px;
      height:14px;
      margin:0;
    }

    .hidden-action{ display:none; }
    .hidden-action.show{ display:inline-flex; }

    .analysis-grid{
      display:grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 1fr);
      gap:12px;
      align-items:stretch;
    }

    .batch-focus-panel .batch-meta{
      font-size:12px;
      color: var(--muted);
    }

    .batch-metrics-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }

    .panel{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius:12px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:0;
    }

    .panel-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .panel-title h3{
      margin:0;
      font-size:14px;
      font-weight:800;
    }

    .panel-tools{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .info-icon{
      width:20px;
      height:20px;
      border-radius:50%;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
      color: var(--muted);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:700;
      cursor:default;
      user-select:none;
    }

    .chart-panel #chartWrap{
      height:360px;
      min-height:360px;
      max-height:360px;
    }

    .chart-panel canvas,
    .compare-chart-wrap canvas{
      width:100% !important;
      height:100% !important;
    }

    .table-panel #table{
      height:360px;
      min-height:360px;
      max-height:360px;
      overflow:hidden;
    }

    .energy-panel #energyChartWrap{
      height:290px;
      min-height:290px;
      max-height:290px;
    }

    .summary-panel #summaryTable{
      height:300px;
      min-height:300px;
      max-height:300px;
      overflow:hidden;
    }

    .inline-status{
      font-size:12px;
      color: var(--muted);
    }

    .compare-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      min-height:300px;
    }

    .compare-chart-wrap{
      min-height:300px;
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
      border-radius:10px;
      padding:10px;
    }
    .compare-metrics{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }

    .metric-card{
      border: 1px solid var(--border);
      border-radius: 10px;
      padding:10px;
      background: rgba(255,255,255,0.03);
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .metric-label{
      font-size:11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .3px;
      font-weight: 700;
    }

    .metric-value{
      font-size:16px;
      font-weight:900;
    }

    .tabulator{
      background: transparent;
      border: none;
      color: var(--text);
      height: 100% !important;
    }

    .tabulator .tabulator-header{
      position: sticky;
      top: 0;
      z-index: 3;
      background: #f3f4f6 !important;
      border-bottom: 1px solid rgba(0,0,0,0.15) !important;
    }

    .tabulator .tabulator-header .tabulator-col{
      border-right: 1px solid rgba(0,0,0,0.10) !important;
    }

    .tabulator .tabulator-header .tabulator-col .tabulator-col-title{
      color: #000 !important;
      font-weight: 900 !important;
    }

    .tabulator .tabulator-row{
      background: transparent;
      border-bottom: 1px solid var(--border);
    }

    .tabulator .tabulator-row.tabulator-row-even{
      background: rgba(255,255,255,0.02);
    }

    .tabulator .tabulator-cell{
      border-right: 1px solid var(--border);
    }

    .row-menu-trigger{
      width:30px;
      height:26px;
      padding:0;
      border-radius:8px;
      font-size:16px;
      line-height:1;
    }

    .row-action-menu{
      position:fixed;
      z-index:1200;
      display:none;
      background: var(--surface-soft);
      border: 1px solid var(--border);
      border-radius:10px;
      box-shadow: 0 18px 36px rgba(0,0,0,0.4);
      min-width:220px;
      padding:6px;
    }

    .row-action-menu.open{ display:block; }

    .row-action-menu button{
      width:100%;
      border:none;
      background: transparent;
      justify-content:flex-start;
      padding:8px 10px;
      border-radius:8px;
      font-size:12px;
      font-weight:700;
    }

    .row-action-menu button:hover{ background: rgba(255,255,255,0.10); }

    .tools{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(4, 8, 16, 0.75);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:1000;
    }

    .modal-backdrop.open{ display:flex; }

    .modal-card{
      width:min(640px, 100%);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius:14px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      box-shadow: 0 24px 48px rgba(0,0,0,0.35);
    }

    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .modal-header h3{
      margin:0;
      font-size:16px;
      font-weight:900;
    }

    .modal-form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .modal-field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .modal-field span{
      font-size:12px;
      color: var(--muted);
      font-weight:700;
    }

    .modal-field.full{ grid-column: 1 / -1; }

    .modal-actions{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    .modal-status{
      font-size:12px;
      color: var(--muted);
    }

    @media (max-width: 1200px){
      .filters-grid{ grid-template-columns: repeat(3, minmax(150px, 1fr)); }
      .analysis-grid{ grid-template-columns: 1fr; }
      .batch-metrics-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .chart-panel #chartWrap,
      .table-panel #table,
      .energy-panel #energyChartWrap{
        height:340px;
        min-height:340px;
        max-height:340px;
      }
    }

    @media (max-width: 900px){
      .topbar{
        grid-template-columns: 1fr;
        align-items:flex-start;
        gap:6px;
        padding:10px 14px;
      }

      .topbar-center,
      .topbar-right{ justify-content:flex-start; align-items:flex-start; }

      .page{ padding:146px 14px 18px; }

      .filters-grid{ grid-template-columns: repeat(2, minmax(150px, 1fr)); }
      .compare-grid{ grid-template-columns: 1fr; min-height:0; }
      .compare-metrics{ grid-template-columns: 1fr 1fr; }
      .summary-panel #summaryTable{
        height:280px;
        min-height:280px;
        max-height:280px;
      }
      .modal-form{ grid-template-columns: 1fr; }
    }

    @media (max-width: 640px){
      .filters-grid{ grid-template-columns: 1fr; }
      .content-actions{ width:100%; justify-content:flex-start; }
      .column-manager{
        right:auto;
        left:0;
      }
      .status-chip,
      .meta-chip{ max-width:100%; }
      #loadStatus{ max-width:140px; }
      .chart-panel #chartWrap,
      .table-panel #table,
      .energy-panel #energyChartWrap,
      .summary-panel #summaryTable{
        height:300px;
        min-height:300px;
        max-height:300px;
      }
      .batch-metrics-grid{ grid-template-columns: 1fr; }
      .compare-chart-wrap{ min-height:260px; }
      .compare-metrics{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
<header class="topbar">
  <div class="topbar-left">
    <a class="nav-link" href="/">Voltar</a>
    <h1>Historico</h1>
  </div>

  <div class="topbar-center">
    <span class="topbar-label">Periodo selecionado</span>
    <strong id="periodSummary">-- -> --</strong>
  </div>

  <div class="topbar-right">
    <span class="status-chip"><span id="loadDot" class="dot"></span><span id="loadStatus">Carregando...</span></span>
    <span class="meta-chip">Registros: <b id="rowCount">0</b></span>
    <span class="meta-chip">Ultimo TS: <b id="lastTs">--</b></span>
    <button id="btnReload" class="btn-primary" type="button">Recarregar</button>
  </div>
</header>
<main class="page">
  <details id="filtersPanel" class="filters-panel">
    <summary>
      <span>Filtros</span>
      <span class="summary-meta">Periodo, lote, composto e batch</span>
    </summary>
    <div class="filters-body">
      <div class="filters-grid">
        <label class="field">
          <span>Inicio</span>
          <input id="rangeStart" type="datetime-local" title="Data/hora inicio" />
        </label>
        <label class="field">
          <span>Fim</span>
          <input id="rangeEnd" type="datetime-local" title="Data/hora fim" />
        </label>
        <label class="field">
          <span>Lote</span>
          <select id="selLote" title="Lote">
            <option value="">Todos os lotes</option>
          </select>
        </label>
        <label class="field">
          <span>Composto</span>
          <select id="selComposto" title="Composto">
            <option value="">Todos os compostos</option>
          </select>
        </label>
        <label class="field">
          <span>Batch</span>
          <select id="selBatch" title="Batch ID">
            <option value="">Todos os batches</option>
          </select>
        </label>
      </div>
      <div class="filters-actions">
        <button id="btnApplyFilters" class="btn-primary" type="button">Aplicar</button>
        <button id="btnClearFilters" type="button">Limpar</button>
      </div>
    </div>
  </details>

  <section class="content-panel">
    <div class="content-header">
      <h2>Analise de batches</h2>
      <div class="content-actions">
        <button id="btnAssignComposto" class="hidden-action" type="button">Vincular composto</button>
        <div class="column-manager-wrap">
          <button id="btnManageCols" type="button">Colunas</button>
          <div id="columnManager" class="column-manager" hidden aria-hidden="true">
            <div class="column-manager-head">
              <strong>Colunas visiveis</strong>
              <button id="btnShowAllCols" type="button">Mostrar todas</button>
            </div>
            <div id="columnManagerList" class="column-manager-list"></div>
          </div>
        </div>
        <button id="btnBatchPdf" type="button">PDF batch</button>
        <button id="btnBatchXlsx" type="button">Excel batch</button>
        <button id="btnExportBatchSummary" type="button">Exportar resumo do periodo (Excel)</button>
        <button id="btnExportXlsx" class="btn-primary" type="button">Exportar Excel</button>
      </div>
    </div>

    <article class="panel batch-focus-panel">
      <div class="panel-title">
        <h3>Resumo do batch selecionado</h3>
      </div>
      <div id="selectedBatchStatus" class="inline-status">Selecione um batch para carregar metricas e energia acumulada.</div>
      <div id="selectedBatchMeta" class="batch-meta">OP -- | Operador --</div>
      <div class="batch-metrics-grid">
        <div class="metric-card">
          <span class="metric-label">Batch ID</span>
          <span id="batchMetricId" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Duracao (s)</span>
          <span id="batchMetricDuration" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">AUC Corrente (A*s)</span>
          <span id="batchMetricCurrentAuc" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Energia proxy (A*s)</span>
          <span id="batchMetricEnergyProxy" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Energia estimada (kWh)</span>
          <span id="batchMetricEnergyKwh" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Potencia media estimada (kW)</span>
          <span id="batchMetricPowerAvgKw" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Potencia pico estimada (kW)</span>
          <span id="batchMetricPowerPeakKw" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Pico corrente (A)</span>
          <span id="batchMetricPeakCorr" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Pico temp (C)</span>
          <span id="batchMetricPeakTemp" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Amostras</span>
          <span id="batchMetricSamples" class="metric-value">--</span>
        </div>
      </div>
      <div id="batchEnergyAssumptions" class="inline-status">Estimado com V=-- e PF=-- (ajustavel no .env).</div>
    </article>

    <div class="analysis-grid">
      <article class="panel chart-panel">
        <div class="panel-title">
          <h3>Grafico historico</h3>
          <div class="panel-tools">
            <span class="info-icon" title="Zoom: rolagem do mouse ou arrastar no grafico. Pan horizontal: arrastar com Shift pressionado ou usar os botoes ◀ ▶." aria-label="Informacao">ℹ</span>
            <button id="btnZoomIn" type="button">+</button>
            <button id="btnZoomOut" type="button">-</button>
            <button id="btnPanLeft" type="button">◀</button>
            <button id="btnPanRight" type="button">▶</button>
            <button id="btnResetZoom" type="button">Resetar visao</button>
          </div>
        </div>
        <div id="chartWrap">
          <canvas id="historyChart"></canvas>
        </div>
      </article>

      <article class="panel table-panel">
        <div class="panel-title">
          <h3>Tabela historica</h3>
          <div class="panel-tools">
            <span class="info-icon" title="Tabela com todas as colunas disponiveis, controle de visibilidade e rolagem interna." aria-label="Informacao">ℹ</span>
          </div>
        </div>
        <div id="table"></div>
      </article>
    </div>

    <article class="panel energy-panel">
      <div class="panel-title">
        <h3>Energia acumulada por batch</h3>
      </div>
      <div id="energyChartStatus" class="inline-status">Selecione um batch para visualizar a curva de energia acumulada.</div>
      <div id="energyChartWrap">
        <canvas id="batchEnergyChart"></canvas>
      </div>
    </article>

    <article class="panel summary-panel">
      <div class="panel-title">
        <h3>Batch Summary</h3>
      </div>
      <div id="batchSummaryStatus" class="inline-status">Carregando resumo...</div>
      <div id="summaryTable"></div>
    </article>

    <article class="panel compare-panel">
      <div class="panel-title">
        <h3>Comparar ciclos</h3>
        <div class="panel-tools">
          <select id="cmpBaselineBatch" title="Batch padrao">
            <option value="">Batch padrao</option>
          </select>
          <select id="cmpTargetBatch" title="Batch alvo">
            <option value="">Batch alvo</option>
          </select>
          <button id="btnCompareBatches" class="btn-primary" type="button">Comparar</button>
          <span class="info-icon" title="Compara assinatura, perfil e metricas entre dois batches." aria-label="Informacao">ℹ</span>
        </div>
      </div>
      <div id="compareStatus" class="inline-status">Selecione dois batches para comparar.</div>
      <div class="compare-grid">
        <div class="compare-chart-wrap">
          <canvas id="compareTempChart"></canvas>
        </div>
        <div class="compare-chart-wrap">
          <canvas id="compareCorrChart"></canvas>
        </div>
      </div>
      <div class="compare-metrics">
        <div class="metric-card">
          <span class="metric-label">RMSE Temp</span>
          <span id="metricRmseTemp" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">RMSE Corrente</span>
          <span id="metricRmseCorr" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Delta Duracao (s)</span>
          <span id="metricDeltaDuration" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Delta AUC Corrente</span>
          <span id="metricDeltaAuc" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Energia proxy baseline (A*s)</span>
          <span id="metricEnergyBaseline" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Energia proxy target (A*s)</span>
          <span id="metricEnergyTarget" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Delta Energia proxy (A*s)</span>
          <span id="metricEnergyDelta" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Energia estimada baseline (kWh)</span>
          <span id="metricEnergyEstBaseline" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Energia estimada target (kWh)</span>
          <span id="metricEnergyEstTarget" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Delta Energia estimada (kWh)</span>
          <span id="metricEnergyEstDelta" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Delta Energia estimada (%)</span>
          <span id="metricEnergyEstDeltaPct" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Delta Pico Temp</span>
          <span id="metricDeltaPeakTemp" class="metric-value">--</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Delta Pico Corrente</span>
          <span id="metricDeltaPeakCorr" class="metric-value">--</span>
        </div>
      </div>
    </article>
  </section>
</main>

<div id="assignModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="assignModalTitle">
    <div class="modal-header">
      <h3 id="assignModalTitle">Vincular Composto ao Batch</h3>
      <button id="btnAssignClose" type="button">Fechar</button>
    </div>
    <div class="modal-form">
      <label class="modal-field">
        <span>Batch ID</span>
        <select id="assignBatch" title="Batch ID">
          <option value="">Selecione um batch</option>
        </select>
      </label>
      <label class="modal-field">
        <span>Composto</span>
        <select id="assignComposto" title="Composto">
          <option value="">Selecione um composto</option>
        </select>
      </label>
      <label class="modal-field full">
        <span>Lote</span>
        <input id="assignLote" type="text" maxlength="120" placeholder="Ex.: LOTE-2026-001" />
      </label>
      <label class="modal-field full">
        <span>Observacoes</span>
        <textarea id="assignObservacoes" maxlength="500" placeholder="Informacoes complementares do batch"></textarea>
      </label>
    </div>
    <div class="modal-actions">
      <span id="assignModalStatus" class="modal-status"></span>
      <div class="tools">
        <button id="btnAssignCancel" type="button">Cancelar</button>
        <button id="btnAssignSave" type="button">Salvar vinculo</button>
      </div>
    </div>
  </div>
</div>

<div id="rowActionMenu" class="row-action-menu" aria-hidden="true">
  <button id="btnRowAssignComposto" type="button">Vincular composto ao batch</button>
</div>

<script>
  function fmt2(n){
    if (n === null || n === undefined || Number.isNaN(Number(n))) return "--";
    return Number(n).toFixed(2);
  }

  function fmtSigned(n, digits = 3){
    if (n === null || n === undefined || Number.isNaN(Number(n))) return "--";
    const num = Number(n);
    if (!Number.isFinite(num)) return "--";
    if (num > 0) return `+${num.toFixed(digits)}`;
    return num.toFixed(digits);
  }

  function fmtNum(n, digits = 3){
    if (n === null || n === undefined || Number.isNaN(Number(n))) return "--";
    const num = Number(n);
    if (!Number.isFinite(num)) return "--";
    return num.toFixed(digits);
  }

  function fmtInt(n){
    if (n === null || n === undefined || Number.isNaN(Number(n))) return "--";
    const num = Number(n);
    if (!Number.isFinite(num)) return "--";
    return String(Math.round(num));
  }

  function asNum(v){
    if (v === null || v === undefined || v === "") return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function pad2(value){
    return String(value).padStart(2, "0");
  }

  function parseInputDateTime(value){
    if (!value) return null;
    const [datePart, timePart] = String(value).split("T");
    if (!datePart) return null;

    const [year, month, day] = datePart.split("-").map((part) => Number(part));
    if (!Number.isFinite(year) || !Number.isFinite(month) || !Number.isFinite(day)) return null;

    let hours = 0;
    let minutes = 0;
    if (timePart) {
      const [hourPart, minutePart] = timePart.split(":");
      hours = Number(hourPart);
      minutes = Number(minutePart);
      if (!Number.isFinite(hours)) hours = 0;
      if (!Number.isFinite(minutes)) minutes = 0;
    }

    return new Date(year, month - 1, day, hours, minutes);
  }

  function formatDateShort(value){
    if (!(value instanceof Date) || Number.isNaN(value.getTime())) return "--";
    return `${pad2(value.getDate())}/${pad2(value.getMonth() + 1)}/${value.getFullYear()}`;
  }

  function formatTopbarTs(value){
    if (value === null || value === undefined || value === "") return "--";
    const raw = String(value).trim();
    if (!raw) return "--";

    const normalized = raw.includes("T") ? raw : raw.replace(" ", "T");
    const parsed = new Date(normalized);
    if (Number.isNaN(parsed.getTime())) return raw;

    return `${pad2(parsed.getDate())}/${pad2(parsed.getMonth() + 1)} ${pad2(parsed.getHours())}:${pad2(parsed.getMinutes())}`;
  }

  function parseTimestampMs(value){
    if (value === null || value === undefined || value === "") return null;
    const raw = String(value).trim();
    if (!raw) return null;
    const normalized = raw.includes("T") ? raw : raw.replace(" ", "T");
    const parsed = new Date(normalized);
    const ms = parsed.getTime();
    return Number.isFinite(ms) ? ms : null;
  }

  function formatDurationSeconds(value){
    const num = asNum(value);
    if (num === null) return "--";
    return fmtNum(num, 1);
  }

  function normalizeBatchId(value){
    if (value === null || value === undefined) return "";
    return String(value).trim();
  }

  const periodSummary = document.getElementById("periodSummary");
  const loadDot = document.getElementById("loadDot");
  const loadStatus = document.getElementById("loadStatus");
  const rowCount = document.getElementById("rowCount");
  const lastTs = document.getElementById("lastTs");

  const selLote = document.getElementById("selLote");
  const selComposto = document.getElementById("selComposto");
  const selBatch = document.getElementById("selBatch");
  const rangeStart = document.getElementById("rangeStart");
  const rangeEnd = document.getElementById("rangeEnd");
  const btnAssignComposto = document.getElementById("btnAssignComposto");

  const assignModal = document.getElementById("assignModal");
  const assignBatch = document.getElementById("assignBatch");
  const assignComposto = document.getElementById("assignComposto");
  const assignLote = document.getElementById("assignLote");
  const assignObservacoes = document.getElementById("assignObservacoes");
  const assignModalStatus = document.getElementById("assignModalStatus");
  const btnAssignSave = document.getElementById("btnAssignSave");

  const cmpBaselineBatch = document.getElementById("cmpBaselineBatch");
  const cmpTargetBatch = document.getElementById("cmpTargetBatch");
  const compareStatus = document.getElementById("compareStatus");
  const metricRmseTemp = document.getElementById("metricRmseTemp");
  const metricRmseCorr = document.getElementById("metricRmseCorr");
  const metricDeltaDuration = document.getElementById("metricDeltaDuration");
  const metricDeltaAuc = document.getElementById("metricDeltaAuc");
  const metricEnergyBaseline = document.getElementById("metricEnergyBaseline");
  const metricEnergyTarget = document.getElementById("metricEnergyTarget");
  const metricEnergyDelta = document.getElementById("metricEnergyDelta");
  const metricEnergyEstBaseline = document.getElementById("metricEnergyEstBaseline");
  const metricEnergyEstTarget = document.getElementById("metricEnergyEstTarget");
  const metricEnergyEstDelta = document.getElementById("metricEnergyEstDelta");
  const metricEnergyEstDeltaPct = document.getElementById("metricEnergyEstDeltaPct");
  const metricDeltaPeakTemp = document.getElementById("metricDeltaPeakTemp");
  const metricDeltaPeakCorr = document.getElementById("metricDeltaPeakCorr");

  const selectedBatchStatus = document.getElementById("selectedBatchStatus");
  const selectedBatchMeta = document.getElementById("selectedBatchMeta");
  const batchMetricId = document.getElementById("batchMetricId");
  const batchMetricDuration = document.getElementById("batchMetricDuration");
  const batchMetricCurrentAuc = document.getElementById("batchMetricCurrentAuc");
  const batchMetricEnergyProxy = document.getElementById("batchMetricEnergyProxy");
  const batchMetricEnergyKwh = document.getElementById("batchMetricEnergyKwh");
  const batchMetricPowerAvgKw = document.getElementById("batchMetricPowerAvgKw");
  const batchMetricPowerPeakKw = document.getElementById("batchMetricPowerPeakKw");
  const batchMetricPeakCorr = document.getElementById("batchMetricPeakCorr");
  const batchMetricPeakTemp = document.getElementById("batchMetricPeakTemp");
  const batchMetricSamples = document.getElementById("batchMetricSamples");
  const batchEnergyAssumptions = document.getElementById("batchEnergyAssumptions");
  const energyChartStatus = document.getElementById("energyChartStatus");
  const batchSummaryStatus = document.getElementById("batchSummaryStatus");

  const rowActionMenu = document.getElementById("rowActionMenu");
  const btnRowAssignComposto = document.getElementById("btnRowAssignComposto");
  const btnManageCols = document.getElementById("btnManageCols");
  const columnManager = document.getElementById("columnManager");
  const columnManagerList = document.getElementById("columnManagerList");
  const btnShowAllCols = document.getElementById("btnShowAllCols");
  const btnZoomIn = document.getElementById("btnZoomIn");
  const btnZoomOut = document.getElementById("btnZoomOut");
  const btnPanLeft = document.getElementById("btnPanLeft");
  const btnPanRight = document.getElementById("btnPanRight");
  const btnExportBatchSummary = document.getElementById("btnExportBatchSummary");

  let rowMenuBatchId = "";
  let rowMenuLote = "";
  let historyAbortController = null;
  let filterOptionsAbortController = null;
  let batchDetailsAbortController = null;
  let summaryAbortController = null;
  let historyLoadSeq = 0;
  let filterOptionsLoadSeq = 0;
  let batchDetailsLoadSeq = 0;
  let summaryLoadSeq = 0;
  let optionsPeriodSignature = "";
  let columnManagerOpen = false;
  const HISTORY_CHART_MAX_POINTS = 1600;
  const BATCH_ENERGY_CHART_MAX_POINTS = 1800;

  function updatePeriodSummary(){
    const startText = formatDateShort(parseInputDateTime(rangeStart.value));
    const endText = formatDateShort(parseInputDateTime(rangeEnd.value));
    periodSummary.textContent = `${startText} -> ${endText}`;
  }

  function updateAssignActionVisibility(){
    const hasSelectedBatch = !selBatch.disabled && normalizeBatchId(selBatch.value) !== "";
    btnAssignComposto.classList.toggle("show", hasSelectedBatch);
    btnAssignComposto.disabled = !hasSelectedBatch;
  }

  function getPeriodSignature(){
    return `${rangeStart.value || ""}|${rangeEnd.value || ""}`;
  }

  function setColumnManagerOpen(isOpen){
    columnManagerOpen = Boolean(isOpen);
    columnManager.hidden = !columnManagerOpen;
    columnManager.setAttribute("aria-hidden", columnManagerOpen ? "false" : "true");
    btnManageCols.setAttribute("aria-expanded", columnManagerOpen ? "true" : "false");
  }

  function toggleColumnManager(){
    setColumnManagerOpen(!columnManagerOpen);
  }

  function hideRowActionMenu(){
    rowActionMenu.classList.remove("open");
    rowActionMenu.setAttribute("aria-hidden", "true");
    rowMenuBatchId = "";
    rowMenuLote = "";
  }

  function showRowActionMenu(event, rowData){
    const batchId = normalizeBatchId(rowData?.batch_id);
    if (!batchId) {
      hideRowActionMenu();
      return;
    }

    rowMenuBatchId = batchId;
    rowMenuLote = rowData?.lote ? String(rowData.lote).trim() : "";

    rowActionMenu.classList.add("open");
    rowActionMenu.setAttribute("aria-hidden", "false");
    rowActionMenu.style.left = "0px";
    rowActionMenu.style.top = "0px";

    const rect = rowActionMenu.getBoundingClientRect();
    const margin = 8;
    const clickX = Number(event?.clientX || 0);
    const clickY = Number(event?.clientY || 0);

    let left = clickX;
    let top = clickY + 8;

    if (left + rect.width > window.innerWidth - margin) {
      left = window.innerWidth - rect.width - margin;
    }

    if (top + rect.height > window.innerHeight - margin) {
      top = clickY - rect.height - 8;
    }

    rowActionMenu.style.left = `${Math.max(margin, left)}px`;
    rowActionMenu.style.top = `${Math.max(margin, top)}px`;
  }

  const chartData = {
    labels: [],
    datasets: [
      { label: "Corrente (A)", data: [], tension: 0.25, pointRadius: 0, yAxisID: "yRight" },
      { label: "Temperatura (°C)", data: [], tension: 0.25, pointRadius: 0, yAxisID: "yTemp" },
      { label: "Tampa (0/1)", data: [], stepped: true, pointRadius: 0, yAxisID: "yRight" },
      { label: "Start (0/1)", data: [], stepped: true, pointRadius: 0, yAxisID: "yRight" },
    ]
  };

  if (window.ChartZoom) {
    try { Chart.register(window.ChartZoom); } catch {}
  }

  const historyChart = new Chart(document.getElementById("historyChart"), {
    type: "line",
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      normalized: true,
      spanGaps: true,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { labels: { color: "#e6edf3" } },
        tooltip: { enabled: true },
        zoom: {
          pan: {
            enabled: true,
            mode: "x",
            modifierKey: "shift",
          },
          zoom: {
            wheel: { enabled: true },
            pinch: { enabled: true },
            drag: {
              enabled: true,
              backgroundColor: "rgba(37,99,235,0.14)",
              borderColor: "rgba(37,99,235,0.70)",
            },
            mode: "x",
          },
        },
      },
      scales: {
        x: { ticks: { color: "#9aa4b2", maxTicksLimit: 8 }, grid: { color: "rgba(255,255,255,0.06)" } },
        yTemp: {
          position: "left",
          min: 0,
          max: 200,
          ticks: { color: "#9aa4b2" },
          grid: { color: "rgba(255,255,255,0.06)" },
          title: { display: true, text: "Temperatura (°C)", color: "#9aa4b2" }
        },
        yRight: {
          position: "right",
          min: 0,
          max: 30,
          ticks: { color: "#9aa4b2" },
          grid: { drawOnChartArea: false, color: "rgba(255,255,255,0.06)" },
          title: { display: true, text: "Corrente / Tampa / Start", color: "#9aa4b2" }
        }
      }
    }
  });

  const batchEnergyChart = new Chart(document.getElementById("batchEnergyChart"), {
    type: "line",
    data: {
      labels: [],
      datasets: [
        {
          label: "Corrente (A)",
          data: [],
          borderColor: "#38bdf8",
          yAxisID: "yCorr",
          tension: 0.2,
          pointRadius: 0,
          borderWidth: 2,
        },
        {
          label: "Energia proxy acumulada (A*s)",
          data: [],
          borderColor: "#f59e0b",
          yAxisID: "yProxy",
          tension: 0.2,
          pointRadius: 0,
          borderWidth: 2,
        },
        {
          label: "Energia estimada acumulada (kWh)",
          data: [],
          borderColor: "#22c55e",
          yAxisID: "yKwh",
          tension: 0.2,
          pointRadius: 0,
          borderWidth: 2,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      normalized: true,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { labels: { color: "#e6edf3" } },
        tooltip: {
          callbacks: {
            title(items){
              if (!items || !items.length) return "";
              return formatTopbarTs(items[0].label || "");
            },
            label(context){
              if (!context || !context.dataset) return "";
              const value = context.raw;
              if (context.dataset.yAxisID === "yProxy") {
                return `Energia proxy acumulada: ${fmtNum(value, 3)} A*s`;
              }
              if (context.dataset.yAxisID === "yKwh") {
                return `Energia estimada acumulada: ${fmtNum(value, 6)} kWh`;
              }
              return `Corrente: ${fmtNum(value, 2)} A`;
            },
          },
        },
      },
      scales: {
        x: {
          ticks: { color: "#9aa4b2", maxTicksLimit: 10 },
          grid: { color: "rgba(255,255,255,0.06)" },
        },
        yCorr: {
          position: "left",
          ticks: { color: "#9aa4b2" },
          title: { display: true, text: "Corrente (A)", color: "#9aa4b2" },
          grid: { color: "rgba(255,255,255,0.06)" },
        },
        yProxy: {
          position: "right",
          ticks: { color: "#9aa4b2" },
          title: { display: true, text: "Energia proxy acumulada (A*s)", color: "#9aa4b2" },
          grid: { drawOnChartArea: false, color: "rgba(255,255,255,0.06)" },
        },
        yKwh: {
          position: "right",
          offset: true,
          ticks: { color: "#9aa4b2" },
          title: { display: true, text: "Energia estimada acumulada (kWh)", color: "#9aa4b2" },
          grid: { drawOnChartArea: false, color: "rgba(255,255,255,0.06)" },
        },
      },
    },
  });

  const stageMarkerPlugin = {
    id: "stageMarkerPlugin",
    afterDatasetsDraw(chart, args, pluginOptions){
      const markers = Array.isArray(pluginOptions?.markers) ? pluginOptions.markers : [];
      if (!markers.length) return;

      const xScale = chart.scales.x;
      const yScale = chart.scales.y;
      if (!xScale || !yScale) return;

      const ctx = chart.ctx;
      for (const marker of markers){
        const value = Number(marker.x);
        if (!Number.isFinite(value)) continue;
        const xPixel = xScale.getPixelForValue(String(Math.round(value)));
        if (!Number.isFinite(xPixel)) continue;

        ctx.save();
        ctx.strokeStyle = marker.color || "rgba(148,163,184,0.9)";
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 4]);
        ctx.beginPath();
        ctx.moveTo(xPixel, yScale.top);
        ctx.lineTo(xPixel, yScale.bottom);
        ctx.stroke();
        ctx.setLineDash([]);

        if (marker.label){
          ctx.fillStyle = marker.color || "#e2e8f0";
          ctx.font = "11px Arial";
          ctx.fillText(String(marker.label), xPixel + 3, yScale.top + 12);
        }
        ctx.restore();
      }
    }
  };
  Chart.register(stageMarkerPlugin);

  const compareAxisLabels = Array.from({ length: 101 }, (_, idx) => String(idx));
  const compareTempChart = new Chart(document.getElementById("compareTempChart"), {
    type: "line",
    data: {
      labels: compareAxisLabels.slice(),
      datasets: [
        { label: "Temp baseline (C)", data: [], borderColor: "#22c55e", tension: 0.2, pointRadius: 0, borderWidth: 2 },
        { label: "Temp target (C)", data: [], borderColor: "#f97316", tension: 0.2, pointRadius: 0, borderWidth: 2 },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      normalized: true,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { labels: { color: "#e6edf3" } },
        stageMarkerPlugin: { markers: [] },
      },
      scales: {
        x: {
          title: { display: true, text: "Tempo normalizado (%)", color: "#9aa4b2" },
          ticks: { color: "#9aa4b2", maxTicksLimit: 12 },
          grid: { color: "rgba(255,255,255,0.06)" },
        },
        y: {
          ticks: { color: "#9aa4b2" },
          title: { display: true, text: "Temperatura (C)", color: "#9aa4b2" },
          grid: { color: "rgba(255,255,255,0.06)" },
        },
      },
    },
  });

  const compareCorrChart = new Chart(document.getElementById("compareCorrChart"), {
    type: "line",
    data: {
      labels: compareAxisLabels.slice(),
      datasets: [
        { label: "Corrente baseline (A)", data: [], borderColor: "#38bdf8", tension: 0.2, pointRadius: 0, borderWidth: 2 },
        { label: "Corrente target (A)", data: [], borderColor: "#f43f5e", tension: 0.2, pointRadius: 0, borderWidth: 2 },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      normalized: true,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { labels: { color: "#e6edf3" } },
        stageMarkerPlugin: { markers: [] },
      },
      scales: {
        x: {
          title: { display: true, text: "Tempo normalizado (%)", color: "#9aa4b2" },
          ticks: { color: "#9aa4b2", maxTicksLimit: 12 },
          grid: { color: "rgba(255,255,255,0.06)" },
        },
        y: {
          ticks: { color: "#9aa4b2" },
          title: { display: true, text: "Corrente (A)", color: "#9aa4b2" },
          grid: { color: "rgba(255,255,255,0.06)" },
        },
      },
    },
  });

  const tableBaseColumns = [
    {
      title: "",
      field: "__row_actions",
      headerSort: false,
      hozAlign: "center",
      width: 52,
      formatter: () => '<button type="button" class="row-menu-trigger" aria-label="Acoes da linha">⋯</button>',
      cellClick: (event, cell) => {
        event.preventDefault();
        event.stopPropagation();
        showRowActionMenu(event, cell.getRow().getData());
      },
    },
    { title: "ID", field: "id", sorter: "number", width: 90 },
    { title: "Data/Hora", field: "ts", sorter: "string", width: 170 },
    { title: "Batch ID", field: "batch_id", sorter: "number", hozAlign: "right", width: 110 },
    { title: "Composto", field: "composto", sorter: "string", width: 240 },
    { title: "Lote", field: "lote", sorter: "string", width: 180 },
    { title: "Observacoes", field: "observacoes", sorter: "string", widthGrow: 2, minWidth: 220 },
    { title: "Temperatura (°C)", field: "temperatura", sorter: "number", hozAlign: "right", formatter: (cell) => fmt2(cell.getValue()) },
    { title: "Corrente (A)", field: "corrente", sorter: "number", hozAlign: "right", formatter: (cell) => fmt2(cell.getValue()) },
    { title: "Tampa (0/1)", field: "tampa", sorter: "number", hozAlign: "center", width: 120 },
    { title: "Start (0/1)", field: "start", sorter: "number", hozAlign: "center", width: 120 },
    { title: "Temp RAW", field: "temp_raw", sorter: "number", hozAlign: "right" },
    { title: "Corr RAW", field: "corr_raw", sorter: "number", hozAlign: "right" },
  ];

  const baseColumnFields = new Set(tableBaseColumns.map((column) => String(column.field || "")));
  const dynamicColumnDefs = new Map();
  const hiddenColumnFields = new Set();
  let tableColumnsSignature = tableBaseColumns.map((column) => String(column.field || "")).join("|");

  const table = new Tabulator("#table", {
    height: "100%",
    layout: "fitDataTable",
    movableColumns: true,
    reactiveData: false,
    clipboard: true,
    pagination: false,
    renderHorizontal: "virtual",
    columns: tableBaseColumns,
  });

  const summaryColumns = [
    { title: "Batch", field: "batch_id", sorter: "number", hozAlign: "right", width: 100 },
    { title: "Inicio", field: "start_ts", sorter: "string", width: 170 },
    { title: "Fim", field: "end_ts", sorter: "string", width: 170 },
    { title: "Duracao (s)", field: "duration_s", sorter: "number", hozAlign: "right", formatter: (cell) => fmtNum(cell.getValue(), 1), width: 120 },
    { title: "Temp min", field: "min_temp", sorter: "number", hozAlign: "right", formatter: (cell) => fmt2(cell.getValue()) },
    { title: "Temp max", field: "max_temp", sorter: "number", hozAlign: "right", formatter: (cell) => fmt2(cell.getValue()) },
    { title: "Temp avg", field: "avg_temp", sorter: "number", hozAlign: "right", formatter: (cell) => fmt2(cell.getValue()) },
    { title: "Corr min", field: "min_corrente", sorter: "number", hozAlign: "right", formatter: (cell) => fmt2(cell.getValue()) },
    { title: "Corr max", field: "max_corrente", sorter: "number", hozAlign: "right", formatter: (cell) => fmt2(cell.getValue()) },
    { title: "Corr avg", field: "avg_corrente", sorter: "number", hozAlign: "right", formatter: (cell) => fmt2(cell.getValue()) },
    { title: "AUC Corrente (A*s)", field: "current_auc", sorter: "number", hozAlign: "right", formatter: (cell) => fmtNum(cell.getValue(), 3), width: 160 },
    { title: "Energia proxy (A*s)", field: "energy_proxy", sorter: "number", hozAlign: "right", formatter: (cell) => fmtNum(cell.getValue(), 3), width: 170 },
    {
      title: "kWh_est",
      field: "energy_est_kwh",
      sorter: "number",
      hozAlign: "right",
      formatter: (cell) => {
        const value = cell.getValue();
        if (value !== null && value !== undefined) return fmtNum(value, 6);
        const row = cell.getRow()?.getData?.() || {};
        return fmtNum(row.energy_estimated_kwh, 6);
      },
      width: 130,
    },
    { title: "Composto", field: "composto", sorter: "string", width: 260 },
    { title: "Lote", field: "lote", sorter: "string", width: 160 },
    { title: "OP", field: "op", sorter: "string", width: 120 },
    { title: "Operador", field: "operador", sorter: "string", width: 150 },
  ];

  const summaryTable = new Tabulator("#summaryTable", {
    height: "100%",
    layout: "fitDataTable",
    movableColumns: true,
    reactiveData: false,
    clipboard: true,
    pagination: false,
    renderHorizontal: "virtual",
    columns: summaryColumns,
  });

  table.on("rowClick", async (event, row) => {
    const target = event?.target;
    if (target instanceof HTMLElement && target.closest(".row-menu-trigger")) return;

    const rowBatchId = normalizeBatchId(row?.getData()?.batch_id);
    if (!rowBatchId) return;
    ensureBatchOption(rowBatchId);
    if (!selBatch.disabled) selBatch.value = rowBatchId;
    updateAssignActionVisibility();
    await loadSelectedBatchDetails(rowBatchId);
  });

  summaryTable.on("rowClick", async (event, row) => {
    const rowBatchId = normalizeBatchId(row?.getData()?.batch_id);
    if (!rowBatchId) return;
    ensureBatchOption(rowBatchId);
    if (!selBatch.disabled) selBatch.value = rowBatchId;
    updateAssignActionVisibility();
    await loadSelectedBatchDetails(rowBatchId);
  });

  function formatColumnTitle(field){
    const clean = String(field || "").trim();
    if (!clean) return "Coluna";
    return clean
      .replace(/[_-]+/g, " ")
      .replace(/\s+/g, " ")
      .trim()
      .replace(/\b\w/g, (char) => char.toUpperCase());
  }

  function buildDynamicColumnDef(field){
    return {
      title: formatColumnTitle(field),
      field,
      sorter: "string",
      minWidth: 150,
    };
  }

  function applyHiddenColumns(){
    for (const field of hiddenColumnFields){
      try {
        table.hideColumn(field);
      } catch {}
    }
  }

  function rebuildColumnManager(){
    columnManagerList.innerHTML = "";
    const columns = table.getColumns().filter((column) => {
      const field = String(column.getField() || "");
      return field.length > 0 && field !== "__row_actions";
    });

    for (const column of columns){
      const field = String(column.getField() || "");
      const definition = column.getDefinition() || {};
      const label = document.createElement("label");
      label.className = "column-toggle";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = column.isVisible();
      checkbox.addEventListener("change", () => {
        if (checkbox.checked) {
          hiddenColumnFields.delete(field);
          table.showColumn(field);
        } else {
          hiddenColumnFields.add(field);
          table.hideColumn(field);
        }
      });

      const text = document.createElement("span");
      text.textContent = definition.title || formatColumnTitle(field);
      label.append(checkbox, text);
      columnManagerList.appendChild(label);
    }
  }

  function syncDynamicColumns(rows){
    const discoveredFields = new Set();
    for (const row of rows){
      if (!row || typeof row !== "object") continue;
      for (const key of Object.keys(row)){
        const field = String(key || "").trim();
        if (!field || field === "__row_actions") continue;
        discoveredFields.add(field);
      }
    }

    for (const field of discoveredFields){
      if (baseColumnFields.has(field) || dynamicColumnDefs.has(field)) continue;
      dynamicColumnDefs.set(field, buildDynamicColumnDef(field));
    }

    const allColumns = [...tableBaseColumns, ...dynamicColumnDefs.values()];
    const signature = allColumns.map((column) => String(column.field || "")).join("|");
    if (signature !== tableColumnsSignature){
      table.setColumns(allColumns);
      tableColumnsSignature = signature;
      applyHiddenColumns();
    }

    rebuildColumnManager();
  }

  async function setTableRows(rows){
    if (typeof table.replaceData === "function") {
      await table.replaceData(rows);
      return;
    }
    table.setData(rows);
  }

  async function setSummaryRows(rows){
    if (typeof summaryTable.replaceData === "function") {
      await summaryTable.replaceData(rows);
      return;
    }
    summaryTable.setData(rows);
  }

  function clearSelectedBatchCards(statusText){
    selectedBatchStatus.textContent = statusText || "Selecione um batch para carregar metricas e energia acumulada.";
    selectedBatchMeta.textContent = "OP -- | Operador --";
    batchMetricId.textContent = "--";
    batchMetricDuration.textContent = "--";
    batchMetricCurrentAuc.textContent = "--";
    batchMetricEnergyProxy.textContent = "--";
    batchMetricEnergyKwh.textContent = "--";
    batchMetricPowerAvgKw.textContent = "--";
    batchMetricPowerPeakKw.textContent = "--";
    batchMetricPeakCorr.textContent = "--";
    batchMetricPeakTemp.textContent = "--";
    batchMetricSamples.textContent = "--";
    batchEnergyAssumptions.textContent = "Estimado com V=-- e PF=-- (ajustavel no .env).";
  }

  function setBatchEnergySeries(points){
    if (!Array.isArray(points) || !points.length) {
      batchEnergyChart.data.labels = [];
      batchEnergyChart.data.datasets[0].data = [];
      batchEnergyChart.data.datasets[1].data = [];
      batchEnergyChart.data.datasets[2].data = [];
      batchEnergyChart.update("none");
      return;
    }

    const labels = points.map((point) => point.ts || "");
    const corr = points.map((point) => point.corrente);
    const energyProxy = points.map((point) => point.energy_proxy);
    const energyEstimatedKwh = points.map((point) => point.energy_est_kwh);

    batchEnergyChart.data.labels = labels;
    batchEnergyChart.data.datasets[0].data = corr;
    batchEnergyChart.data.datasets[1].data = energyProxy;
    batchEnergyChart.data.datasets[2].data = energyEstimatedKwh;
    batchEnergyChart.update("none");
  }

  function decimatePoints(points, maxPoints){
    if (!Array.isArray(points) || points.length <= maxPoints) return points || [];
    const step = Math.max(1, Math.ceil(points.length / maxPoints));
    const out = [];
    for (let i = 0; i < points.length; i += step){
      out.push(points[i]);
    }
    const last = points[points.length - 1];
    if (out[out.length - 1] !== last) out.push(last);
    return out;
  }

  function buildEnergyCurves(rowsDesc, metrics){
    if (!Array.isArray(rowsDesc) || !rowsDesc.length) return [];

    const rowsAsc = rowsDesc.slice().reverse();
    const points = [];
    let cumulativeProxy = 0.0;
    let cumulativeEstimatedWh = 0.0;
    let prevTsMs = null;
    let prevCorr = null;

    const energyEnabled = metrics?.energy_est_enabled !== false;
    const vllVolts = asNum(metrics?.vll_volts);
    const pfAssumed = asNum(metrics?.power_factor_assumed);
    const canEstimateKwh = Boolean(
      energyEnabled &&
      vllVolts !== null &&
      vllVolts > 0 &&
      pfAssumed !== null &&
      pfAssumed > 0
    );

    for (const row of rowsAsc){
      const tsText = String(row?.ts || "");
      const tsMs = parseTimestampMs(tsText);
      const corr = asNum(row?.corrente);

      if (prevTsMs !== null && tsMs !== null && corr !== null && prevCorr !== null) {
        const deltaS = (tsMs - prevTsMs) / 1000.0;
        if (deltaS > 0) {
          cumulativeProxy += ((prevCorr + corr) / 2.0) * deltaS;

          if (canEstimateKwh) {
            const prevPowerW = Math.sqrt(3) * vllVolts * prevCorr * pfAssumed;
            const powerW = Math.sqrt(3) * vllVolts * corr * pfAssumed;
            cumulativeEstimatedWh += ((prevPowerW + powerW) / 2.0) * deltaS / 3600.0;
          }
        }
      }

      points.push({
        ts: tsText,
        corrente: corr,
        energy_proxy: cumulativeProxy,
        energy_est_kwh: canEstimateKwh ? (cumulativeEstimatedWh / 1000.0) : null,
      });

      prevTsMs = tsMs;
      prevCorr = corr;
    }

    return decimatePoints(points, BATCH_ENERGY_CHART_MAX_POINTS);
  }

  function updateSelectedBatchCards(batchId, payload){
    const metrics = payload?.metrics || {};
    const meta = payload?.meta || {};
    const energyEstKwh = metrics?.energy_est_kwh ?? metrics?.energy_estimated_kwh;
    const hasEstimatedEnergy = energyEstKwh !== null && energyEstKwh !== undefined;

    selectedBatchStatus.textContent = `Batch ${batchId} carregado.`;
    selectedBatchMeta.textContent = `OP ${meta?.op || "--"} | Operador ${meta?.operador || "--"}`;
    batchMetricId.textContent = String(batchId || "--");
    batchMetricDuration.textContent = formatDurationSeconds(metrics?.duration_s);
    batchMetricCurrentAuc.textContent = fmtNum(metrics?.current_auc, 3);
    batchMetricEnergyProxy.textContent = fmtNum(metrics?.energy_proxy, 3);
    batchMetricEnergyKwh.textContent = hasEstimatedEnergy ? fmtNum(energyEstKwh, 6) : "--";
    batchMetricPowerAvgKw.textContent = fmtNum(metrics?.power_est_avg_kw, 3);
    batchMetricPowerPeakKw.textContent = fmtNum(metrics?.power_est_peak_kw, 3);
    batchMetricPeakCorr.textContent = fmtNum(metrics?.max_corrente, 2);
    batchMetricPeakTemp.textContent = fmtNum(metrics?.max_temp, 2);
    batchMetricSamples.textContent = fmtInt(metrics?.samples);

    const assumedPf = asNum(metrics?.power_factor_assumed);
    const assumedVll = asNum(metrics?.vll_volts);
    if (metrics?.energy_est_enabled === false) {
      batchEnergyAssumptions.textContent = "Energia estimada desabilitada no .env (ENERGY_EST_ENABLED=false).";
    } else if (assumedPf !== null && assumedVll !== null) {
      batchEnergyAssumptions.textContent = `Estimado com V=${fmtNum(assumedVll, 0)}V e PF=${fmtNum(assumedPf, 2)} (ajustavel no .env).`;
    } else {
      batchEnergyAssumptions.textContent = "Parametros de energia estimada indisponiveis para este batch.";
    }
  }

  function rebuildChart(rowsDesc){
    const total = Array.isArray(rowsDesc) ? rowsDesc.length : 0;
    if (!total){
      chartData.labels = [];
      chartData.datasets[0].data = [];
      chartData.datasets[1].data = [];
      chartData.datasets[2].data = [];
      chartData.datasets[3].data = [];
      historyChart.update("none");
      return;
    }

    const step = Math.max(1, Math.ceil(total / HISTORY_CHART_MAX_POINTS));
    const points = Math.ceil(total / step);
    const labels = new Array(points);
    const corrente = new Array(points);
    const temperatura = new Array(points);
    const tampa = new Array(points);
    const start = new Array(points);

    let idx = 0;
    for (let rowIndex = total - 1; rowIndex >= 0; rowIndex -= step){
      const row = rowsDesc[rowIndex] || {};
      labels[idx] = row.ts || "";
      corrente[idx] = asNum(row.corrente);
      temperatura[idx] = asNum(row.temperatura);
      tampa[idx] = asNum(row.tampa);
      start[idx] = asNum(row.start);
      idx += 1;
    }

    chartData.labels = labels;
    chartData.datasets[0].data = corrente;
    chartData.datasets[1].data = temperatura;
    chartData.datasets[2].data = tampa;
    chartData.datasets[3].data = start;
    historyChart.update("none");
  }

  function zoomHistoryChart(factor){
    if (typeof historyChart.zoom === "function") {
      historyChart.zoom(factor);
    }
  }

  function panHistoryChart(deltaX){
    if (typeof historyChart.pan === "function") {
      historyChart.pan({ x: deltaX }, undefined, "default");
    }
  }

  function resetHistoryViewport(){
    if (typeof historyChart.resetZoom === "function") {
      historyChart.resetZoom();
    }
  }
  function setSelectOptions(selectEl, values, defaultLabel, columnName){
    const previousValue = selectEl.value;
    selectEl.innerHTML = "";

    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = columnName ? defaultLabel : `${defaultLabel} (indisponivel)`;
    selectEl.appendChild(defaultOption);

    if (!columnName){
      selectEl.disabled = true;
      selectEl.value = "";
      return;
    }

    selectEl.disabled = false;
    for (const value of values){
      const opt = document.createElement("option");
      opt.value = value;
      opt.textContent = value;
      selectEl.appendChild(opt);
    }

    const hasPrevious = values.includes(previousValue);
    selectEl.value = hasPrevious ? previousValue : "";
  }

  function normalizeBatchValues(values){
    return (Array.isArray(values) ? values : [])
      .map((value) => String(value).trim())
      .filter((value) => value.length > 0)
      .sort((left, right) => {
        const leftNum = Number(left);
        const rightNum = Number(right);
        if (Number.isFinite(leftNum) && Number.isFinite(rightNum)) return leftNum - rightNum;
        return left.localeCompare(right, "pt-BR");
      });
  }

  function setCompareSelectOptions(selectEl, values, defaultLabel){
    const previousValue = selectEl.value;
    selectEl.innerHTML = "";

    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = defaultLabel;
    selectEl.appendChild(defaultOption);

    for (const value of values){
      const option = document.createElement("option");
      option.value = value;
      option.textContent = value;
      selectEl.appendChild(option);
    }

    if (values.includes(previousValue)) {
      selectEl.value = previousValue;
    } else {
      selectEl.value = "";
    }
  }

  function buildPeriodParams(){
    const params = new URLSearchParams();
    if (rangeStart.value) params.set("start", rangeStart.value);
    if (rangeEnd.value) params.set("end", rangeEnd.value);
    return params;
  }

  function buildHistoryParams(){
    const params = buildPeriodParams();
    if (!selLote.disabled && selLote.value) params.set("lote", selLote.value);
    if (!selComposto.disabled && selComposto.value) params.set("composto", selComposto.value);
    if (!selBatch.disabled && selBatch.value) params.set("batch_id", selBatch.value);
    return params;
  }

  function buildSummaryParams(){
    return buildHistoryParams();
  }

  function ensureBatchOption(batchId){
    const normalized = normalizeBatchId(batchId);
    if (!normalized || selBatch.disabled) return;
    const exists = Array.from(selBatch.options).some((option) => option.value === normalized);
    if (exists) return;
    const option = document.createElement("option");
    option.value = normalized;
    option.textContent = normalized;
    selBatch.appendChild(option);
  }

  async function loadSelectedBatchDetails(batchId){
    const normalizedBatchId = normalizeBatchId(batchId);
    if (!normalizedBatchId) {
      clearSelectedBatchCards("Selecione um batch para carregar metricas e energia acumulada.");
      energyChartStatus.textContent = "Selecione um batch para visualizar a curva de energia acumulada.";
      setBatchEnergySeries([]);
      return;
    }

    const requestSeq = ++batchDetailsLoadSeq;
    if (batchDetailsAbortController) batchDetailsAbortController.abort();
    batchDetailsAbortController = new AbortController();

    selectedBatchStatus.textContent = `Carregando batch ${normalizedBatchId}...`;
    energyChartStatus.textContent = `Carregando curva de energia do batch ${normalizedBatchId}...`;

    const historyParams = new URLSearchParams();
    historyParams.set("batch_id", normalizedBatchId);
    const metricsUrl = `/api/batches/${encodeURIComponent(normalizedBatchId)}/metrics`;
    const historyUrl = `/api/history?${historyParams.toString()}`;

    try {
      const [metricsRes, historyRes] = await Promise.all([
        fetch(metricsUrl, { cache: "no-store", signal: batchDetailsAbortController.signal }),
        fetch(historyUrl, { cache: "no-store", signal: batchDetailsAbortController.signal }),
      ]);
      if (!metricsRes.ok) throw new Error(`HTTP ${metricsRes.status} (metrics)`);
      if (!historyRes.ok) throw new Error(`HTTP ${historyRes.status} (history/batch)`);

      const [metricsPayload, historyPayload] = await Promise.all([
        metricsRes.json(),
        historyRes.json(),
      ]);
      if (requestSeq !== batchDetailsLoadSeq) return;

      updateSelectedBatchCards(normalizedBatchId, metricsPayload);
      const rows = Array.isArray(historyPayload?.rows) ? historyPayload.rows : [];
      const curve = buildEnergyCurves(rows, metricsPayload?.metrics || {});
      setBatchEnergySeries(curve);
      energyChartStatus.textContent = curve.length
        ? `Curvas acumuladas (proxy A*s e energia estimada kWh) por integracao trapezoidal (${curve.length} pontos).`
        : "Sem pontos suficientes para gerar curva de energia.";
    } catch (err) {
      if (err && err.name === "AbortError") return;
      clearSelectedBatchCards(`Erro ao carregar batch ${normalizedBatchId}: ${err.message}`);
      energyChartStatus.textContent = `Erro ao carregar curva de energia: ${err.message}`;
      setBatchEnergySeries([]);
    }
  }

  async function loadBatchSummary(){
    const requestSeq = ++summaryLoadSeq;
    if (summaryAbortController) summaryAbortController.abort();
    summaryAbortController = new AbortController();
    batchSummaryStatus.textContent = "Carregando resumo por batch...";

    try {
      const params = buildSummaryParams();
      const query = params.toString();
      const url = query ? `/api/batches/summary?${query}` : "/api/batches/summary";
      const res = await fetch(url, { cache: "no-store", signal: summaryAbortController.signal });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const payload = await res.json();
      if (requestSeq !== summaryLoadSeq) return;
      const rows = Array.isArray(payload?.rows) ? payload.rows : [];
      await setSummaryRows(rows);

      const total = Number(payload?.meta?.total_batches || rows.length || 0);
      batchSummaryStatus.textContent = `${total} batches no periodo. Clique em uma linha para focar no batch.`;
    } catch (err) {
      if (err && err.name === "AbortError") return;
      batchSummaryStatus.textContent = `Erro ao carregar resumo: ${err.message}`;
      await setSummaryRows([]);
    }
  }

  async function loadFilterOptions(){
    const requestSeq = ++filterOptionsLoadSeq;
    if (filterOptionsAbortController) filterOptionsAbortController.abort();
    filterOptionsAbortController = new AbortController();

    const params = buildPeriodParams();
    const query = params.toString();
    const url = query ? `/api/history/options?${query}` : "/api/history/options";

    try {
      const res = await fetch(url, { cache: "no-store", signal: filterOptionsAbortController.signal });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const payload = await res.json();
      if (requestSeq !== filterOptionsLoadSeq) return;

      const columns = payload.columns || {};
      const options = payload.options || {};
      const batchValues = normalizeBatchValues(options.batch_id);

      setSelectOptions(selLote, Array.isArray(options.lote) ? options.lote : [], "Todos os lotes", columns.lote);
      setSelectOptions(selComposto, Array.isArray(options.composto) ? options.composto : [], "Todos os compostos", columns.composto);
      setSelectOptions(selBatch, batchValues, "Todos os batches", columns.batch_id);
      setCompareSelectOptions(cmpBaselineBatch, batchValues, "Batch padrao");
      setCompareSelectOptions(cmpTargetBatch, batchValues, "Batch alvo");
      optionsPeriodSignature = getPeriodSignature();
      updateAssignActionVisibility();
    } catch (err) {
      if (err && err.name === "AbortError") return;
      throw err;
    }
  }

  function setModalSelectOptions(selectEl, values, defaultLabel){
    const previousValue = selectEl.value;
    selectEl.innerHTML = "";

    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = defaultLabel;
    selectEl.appendChild(defaultOption);

    for (const value of values){
      const opt = document.createElement("option");
      opt.value = value;
      opt.textContent = value;
      selectEl.appendChild(opt);
    }

    selectEl.disabled = values.length === 0;
    if (values.includes(previousValue)) {
      selectEl.value = previousValue;
    } else {
      selectEl.value = "";
    }
  }

  function setModalCompostos(items){
    const previousValue = assignComposto.value;
    assignComposto.innerHTML = "";

    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = "Selecione um composto";
    assignComposto.appendChild(defaultOption);

    for (const item of items){
      const opt = document.createElement("option");
      if (item.codigo !== undefined && item.codigo !== null && item.codigo !== "") {
        opt.value = String(item.codigo);
        opt.dataset.codprod = String(item.codigo);
      } else {
        opt.value = String(item.descricao || "");
      }
      opt.dataset.descricao = String(item.descricao || "");
      opt.textContent = item.codigo ? `[${item.codigo}] ${item.descricao}` : String(item.descricao || "");
      assignComposto.appendChild(opt);
    }

    assignComposto.disabled = items.length === 0;
    if (Array.from(assignComposto.options).some((opt) => opt.value === previousValue)) {
      assignComposto.value = previousValue;
    } else {
      assignComposto.value = "";
    }
  }

  async function loadAssignModalOptions(preferredBatchId = ""){
    assignModalStatus.textContent = "Carregando opcoes...";
    btnAssignSave.disabled = true;

    const [historyRes, compostosRes] = await Promise.all([
      fetch("/api/history/options", { cache: "no-store" }),
      fetch("/api/compostos", { cache: "no-store" }),
    ]);

    if (!historyRes.ok) throw new Error(`HTTP ${historyRes.status} (history/options)`);

    const historyPayload = await historyRes.json();
    const historyOptions = historyPayload.options || {};

    const batchValues = normalizeBatchValues(historyOptions.batch_id);
    setModalSelectOptions(assignBatch, batchValues, "Selecione um batch");

    const catalogItems = [];
    if (compostosRes.ok) {
      const compostosPayload = await compostosRes.json();
      const items = Array.isArray(compostosPayload.items) ? compostosPayload.items : [];
      for (const item of items){
        if (!item || !item.descricao) continue;
        catalogItems.push({
          codigo: item.codigo,
          descricao: String(item.descricao).trim(),
        });
      }
    }

    if (catalogItems.length > 0) {
      setModalCompostos(catalogItems);
    } else {
      const fallbackCompostos = (Array.isArray(historyOptions.composto) ? historyOptions.composto : [])
        .map((desc) => ({ codigo: null, descricao: String(desc || "").trim() }))
        .filter((item) => item.descricao.length > 0);
      setModalCompostos(fallbackCompostos);
    }

    const selectedBatch = normalizeBatchId(preferredBatchId) || normalizeBatchId(selBatch.value);
    if (selectedBatch && Array.from(assignBatch.options).some((opt) => opt.value === selectedBatch)) {
      assignBatch.value = selectedBatch;
    }

    if (selComposto.value) {
      const selected = Array.from(assignComposto.options).find(
        (opt) => (opt.dataset.descricao || "").toUpperCase() === selComposto.value.trim().toUpperCase()
      );
      if (selected) assignComposto.value = selected.value;
    }

    if (!assignLote.value && selLote.value) {
      assignLote.value = selLote.value;
    }

    assignModalStatus.textContent = "";
    btnAssignSave.disabled = assignBatch.disabled || assignComposto.disabled;
  }
  async function openAssignModal(context = {}){
    const preferredBatchId = normalizeBatchId(context.batchId);
    const preferredLote = String(context.lote || "").trim();

    assignLote.value = preferredLote || selLote.value || "";
    assignObservacoes.value = "";
    assignModal.classList.add("open");
    assignModal.setAttribute("aria-hidden", "false");
    try {
      await loadAssignModalOptions(preferredBatchId);
    } catch (err) {
      assignModalStatus.textContent = `Erro ao carregar opcoes: ${err.message}`;
      btnAssignSave.disabled = true;
    }
  }

  function closeAssignModal(){
    assignModal.classList.remove("open");
    assignModal.setAttribute("aria-hidden", "true");
    assignModalStatus.textContent = "";
  }

  function ignoredMessages(payload){
    const out = [];
    const filters = payload.filters || {};
    for (const key of ["lote", "composto", "batch_id"]){
      const meta = filters[key];
      if (meta && meta.requested && !meta.applied && meta.ignored_reason){
        out.push(meta.ignored_reason);
      }
    }
    return out;
  }

  async function loadHistory(){
    const requestSeq = ++historyLoadSeq;
    if (historyAbortController) historyAbortController.abort();
    historyAbortController = new AbortController();

    loadStatus.textContent = "Carregando...";
    loadDot.classList.remove("ok");

    try {
      const params = buildHistoryParams();
      const query = params.toString();
      const url = query ? `/api/history?${query}` : "/api/history";

      const res = await fetch(url, { cache: "no-store", signal: historyAbortController.signal });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const payload = await res.json();
      if (requestSeq !== historyLoadSeq) return;
      const rows = Array.isArray(payload.rows) ? payload.rows : [];

      syncDynamicColumns(rows);
      await setTableRows(rows);
      rebuildChart(rows);

      rowCount.textContent = String(rows.length);
      lastTs.textContent = rows.length ? formatTopbarTs(rows[0].ts) : "--";

      const ignored = ignoredMessages(payload);
      loadStatus.textContent = ignored.length ? `Historico carregado (${ignored.join(" | ")})` : "Historico carregado";
      loadDot.classList.add("ok");

      const selectedBatch = normalizeBatchId(selBatch.value);
      await Promise.allSettled([
        loadBatchSummary(),
        loadSelectedBatchDetails(selectedBatch),
      ]);
    } catch (err) {
      if (err && err.name === "AbortError") return;
      loadStatus.textContent = `Erro ao carregar: ${err.message}`;
      loadDot.classList.remove("ok");
    }
  }

  function pickBatchForReport(){
    if (!selBatch.disabled && selBatch.value) return String(selBatch.value).trim();
    const rows = table.getData();
    if (rows.length === 1 && rows[0] && rows[0].batch_id !== null && rows[0].batch_id !== undefined && rows[0].batch_id !== ""){
      return String(rows[0].batch_id).trim();
    }
    return "";
  }

  function extractFilename(contentDisposition, fallbackName){
    if (!contentDisposition) return fallbackName;
    const utf8Match = contentDisposition.match(/filename\\*=UTF-8''([^;]+)/i);
    if (utf8Match && utf8Match[1]) return decodeURIComponent(utf8Match[1]);
    const plainMatch = contentDisposition.match(/filename="?([^";]+)"?/i);
    if (plainMatch && plainMatch[1]) return plainMatch[1];
    return fallbackName;
  }

  async function downloadBatchReport(format){
    const batchId = pickBatchForReport();
    if (!batchId){
      loadStatus.textContent = "Selecione um batch no filtro para baixar o relatorio.";
      loadDot.classList.remove("ok");
      return;
    }

    const includeRaw = format === "xlsx" ? 1 : 0;
    const url = `/api/batches/${encodeURIComponent(batchId)}/report?format=${encodeURIComponent(format)}&include_raw=${includeRaw}`;

    loadStatus.textContent = `Gerando ${format.toUpperCase()} do batch ${batchId}...`;
    loadDot.classList.remove("ok");

    try {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok){
        let detail = `HTTP ${res.status}`;
        try {
          const payload = await res.json();
          if (payload && payload.detail) detail = payload.detail;
        } catch {}
        throw new Error(detail);
      }

      const blob = await res.blob();
      const fallbackName = `batch_${batchId}.${format}`;
      const fileName = extractFilename(res.headers.get("content-disposition"), fallbackName);
      const downloadUrl = URL.createObjectURL(blob);
      const anchor = document.createElement("a");
      anchor.href = downloadUrl;
      anchor.download = fileName;
      document.body.appendChild(anchor);
      anchor.click();
      anchor.remove();
      URL.revokeObjectURL(downloadUrl);

      loadStatus.textContent = `Relatorio ${format.toUpperCase()} do batch ${batchId} baixado.`;
      loadDot.classList.add("ok");
    } catch (err) {
      loadStatus.textContent = `Erro no download: ${err.message}`;
      loadDot.classList.remove("ok");
    }
  }

  async function downloadBatchSummaryExport(){
    const params = buildSummaryParams();
    const query = params.toString();
    const url = query ? `/api/batches/summary/export?${query}` : "/api/batches/summary/export";

    loadStatus.textContent = "Gerando resumo de batches (Excel)...";
    loadDot.classList.remove("ok");

    try {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok){
        let detail = `HTTP ${res.status}`;
        try {
          const payload = await res.json();
          if (payload && payload.detail) detail = payload.detail;
        } catch {}
        throw new Error(detail);
      }

      const blob = await res.blob();
      const fallbackName = "batches_resumo.xlsx";
      const fileName = extractFilename(res.headers.get("content-disposition"), fallbackName);
      const downloadUrl = URL.createObjectURL(blob);
      const anchor = document.createElement("a");
      anchor.href = downloadUrl;
      anchor.download = fileName;
      document.body.appendChild(anchor);
      anchor.click();
      anchor.remove();
      URL.revokeObjectURL(downloadUrl);

      loadStatus.textContent = "Resumo de batches exportado.";
      loadDot.classList.add("ok");
    } catch (err) {
      loadStatus.textContent = `Erro no export do resumo: ${err.message}`;
      loadDot.classList.remove("ok");
    }
  }

  function setCompareMetrics(payload){
    const metrics = payload?.deviation_metrics || {};
    const baselineMetrics = payload?.baseline?.metrics || {};
    const targetMetrics = payload?.target?.metrics || {};
    const baselineEnergyEst = baselineMetrics?.energy_est_kwh ?? baselineMetrics?.energy_estimated_kwh;
    const targetEnergyEst = targetMetrics?.energy_est_kwh ?? targetMetrics?.energy_estimated_kwh;
    const energyEstDiff = metrics?.energy_est_kwh_diff ?? metrics?.energy_estimated_kwh_diff;

    metricRmseTemp.textContent = fmt2(metrics?.rmse_temp);
    metricRmseCorr.textContent = fmt2(metrics?.rmse_corrente);
    metricDeltaDuration.textContent = fmtSigned(metrics?.duration_diff_s, 3);
    metricDeltaAuc.textContent = fmtSigned(metrics?.current_auc_diff, 3);
    metricEnergyBaseline.textContent = fmtNum(baselineMetrics?.energy_proxy, 3);
    metricEnergyTarget.textContent = fmtNum(targetMetrics?.energy_proxy, 3);
    metricEnergyDelta.textContent = fmtSigned(
      metrics?.energy_proxy_diff !== undefined && metrics?.energy_proxy_diff !== null
        ? metrics.energy_proxy_diff
        : metrics?.current_auc_diff,
      3
    );
    metricEnergyEstBaseline.textContent = fmtNum(baselineEnergyEst, 6);
    metricEnergyEstTarget.textContent = fmtNum(targetEnergyEst, 6);
    metricEnergyEstDelta.textContent = fmtSigned(energyEstDiff, 6);
    metricEnergyEstDeltaPct.textContent = fmtSigned(metrics?.energy_est_kwh_diff_pct, 3);
    metricDeltaPeakTemp.textContent = fmtSigned(metrics?.peak_temp_diff, 2);
    metricDeltaPeakCorr.textContent = fmtSigned(metrics?.peak_corrente_diff, 2);
  }

  function markersToLines(markers, prefix, color){
    const markerMap = [
      ["ramp_end_pct", "Ramp"],
      ["plateau_start_pct", "Plato"],
      ["discharge_pct", "Descarga"],
    ];
    const lines = [];
    for (const [key, label] of markerMap){
      const value = Number(markers?.[key]);
      if (!Number.isFinite(value)) continue;
      lines.push({ x: value, label: `${prefix}-${label}`, color });
    }
    return lines;
  }

  function updateCompareCharts(payload){
    const baselineProfile = payload?.baseline?.profile || {};
    const targetProfile = payload?.target?.profile || {};

    const axis = Array.isArray(baselineProfile.time_pct) && baselineProfile.time_pct.length
      ? baselineProfile.time_pct
      : compareAxisLabels.map((value) => Number(value));
    const labels = axis.map((value) => String(Math.round(Number(value))));

    compareTempChart.data.labels = labels;
    compareTempChart.data.datasets[0].data = Array.isArray(baselineProfile.temp) ? baselineProfile.temp : [];
    compareTempChart.data.datasets[1].data = Array.isArray(targetProfile.temp) ? targetProfile.temp : [];

    compareCorrChart.data.labels = labels;
    compareCorrChart.data.datasets[0].data = Array.isArray(baselineProfile.corrente) ? baselineProfile.corrente : [];
    compareCorrChart.data.datasets[1].data = Array.isArray(targetProfile.corrente) ? targetProfile.corrente : [];

    const markerLines = [
      ...markersToLines(baselineProfile.markers, "B", "#22c55e"),
      ...markersToLines(targetProfile.markers, "T", "#f59e0b"),
    ];
    compareTempChart.options.plugins.stageMarkerPlugin.markers = markerLines;
    compareCorrChart.options.plugins.stageMarkerPlugin.markers = markerLines;

    compareTempChart.update("none");
    compareCorrChart.update("none");
  }

  async function runBatchCompare(){
    const baselineBatch = String(cmpBaselineBatch.value || "").trim();
    const targetBatch = String(cmpTargetBatch.value || "").trim();

    if (!baselineBatch || !targetBatch){
      compareStatus.textContent = "Selecione batch padrao e batch alvo.";
      return;
    }

    compareStatus.textContent = "Comparando ciclos...";
    try {
      const params = new URLSearchParams({
        baseline_batch_id: baselineBatch,
        target_batch_id: targetBatch,
      });
      const res = await fetch(`/api/batches/compare?${params.toString()}`, { cache: "no-store" });
      if (!res.ok){
        let detail = `HTTP ${res.status}`;
        try {
          const payload = await res.json();
          if (payload && payload.detail) detail = payload.detail;
        } catch {}
        throw new Error(detail);
      }

      const payload = await res.json();
      updateCompareCharts(payload);
      setCompareMetrics(payload);

      const baselineSignature = payload?.baseline?.signature || "--";
      const targetSignature = payload?.target?.signature || "--";
      compareStatus.textContent = `Comparacao pronta. Assinaturas: baseline ${baselineSignature.slice(0, 10)}..., target ${targetSignature.slice(0, 10)}...`;
    } catch (err) {
      compareStatus.textContent = `Erro na comparacao: ${err.message}`;
    }
  }
  document.getElementById("btnApplyFilters").onclick = async () => {
    const shouldRefreshOptions = getPeriodSignature() !== optionsPeriodSignature;
    if (shouldRefreshOptions) {
      await Promise.allSettled([loadFilterOptions()]);
    }
    await Promise.allSettled([loadHistory()]);
  };

  btnAssignComposto.onclick = async () => {
    const selectedBatch = normalizeBatchId(selBatch.value);
    if (!selectedBatch) return;
    await openAssignModal({ batchId: selectedBatch });
  };

  btnRowAssignComposto.onclick = async () => {
    const contextBatchId = normalizeBatchId(rowMenuBatchId);
    const contextLote = rowMenuLote;
    hideRowActionMenu();

    if (!contextBatchId) return;
    await openAssignModal({ batchId: contextBatchId, lote: contextLote });
  };

  document.getElementById("btnBatchPdf").onclick = async () => {
    await downloadBatchReport("pdf");
  };

  document.getElementById("btnBatchXlsx").onclick = async () => {
    await downloadBatchReport("xlsx");
  };

  document.getElementById("btnAssignClose").onclick = closeAssignModal;
  document.getElementById("btnAssignCancel").onclick = closeAssignModal;

  assignModal.onclick = (ev) => {
    if (ev.target === assignModal) closeAssignModal();
  };

  document.addEventListener("keydown", (ev) => {
    if (ev.key === "Escape") {
      if (assignModal.classList.contains("open")) closeAssignModal();
      hideRowActionMenu();
      setColumnManagerOpen(false);
    }
  });

  document.addEventListener("click", (ev) => {
    const target = ev.target;
    if (!(target instanceof HTMLElement)) return;
    const clickedRowMenu = Boolean(target.closest("#rowActionMenu") || target.closest(".row-menu-trigger"));
    const clickedColumnMenu = Boolean(target.closest("#columnManager") || target.closest("#btnManageCols"));
    if (!clickedRowMenu) hideRowActionMenu();
    if (!clickedColumnMenu) setColumnManagerOpen(false);
  });

  window.addEventListener("resize", hideRowActionMenu);
  window.addEventListener("scroll", hideRowActionMenu, true);
  window.addEventListener("resize", () => setColumnManagerOpen(false));
  window.addEventListener("scroll", () => setColumnManagerOpen(false), true);

  btnAssignSave.onclick = async () => {
    if (!assignBatch.value) {
      assignModalStatus.textContent = "Selecione um batch.";
      return;
    }
    if (!assignComposto.value) {
      assignModalStatus.textContent = "Selecione um composto.";
      return;
    }

    const selectedComposto = assignComposto.options[assignComposto.selectedIndex];
    const params = new URLSearchParams();
    if (selectedComposto && selectedComposto.dataset.codprod) {
      params.set("codprod", selectedComposto.dataset.codprod);
    } else {
      const descricao = (selectedComposto?.dataset.descricao || assignComposto.value || "").trim();
      if (descricao) params.set("descricao", descricao);
    }

    const lote = assignLote.value.trim();
    const observacoes = assignObservacoes.value.trim();
    if (lote) params.set("lote", lote);
    if (observacoes) params.set("observacoes", observacoes);

    loadStatus.textContent = "Vinculando composto...";
    loadDot.classList.remove("ok");
    assignModalStatus.textContent = "Salvando vinculo...";
    btnAssignSave.disabled = true;

    try {
      const query = params.toString();
      const url = query
        ? `/api/batches/${encodeURIComponent(assignBatch.value)}/composto?${query}`
        : `/api/batches/${encodeURIComponent(assignBatch.value)}/composto`;
      const res = await fetch(url, { method: "POST" });
      const payload = await res.json();
      if (!res.ok) {
        throw new Error(payload.detail || `HTTP ${res.status}`);
      }

      assignModalStatus.textContent = "";
      closeAssignModal();

      const updatedRows = Number(payload.updated_rows || 0);
      loadStatus.textContent = `Batch ${assignBatch.value} atualizado (${updatedRows} linhas).`;
      loadDot.classList.add("ok");
      await Promise.allSettled([loadFilterOptions(), loadHistory()]);
    } catch (err) {
      assignModalStatus.textContent = `Erro: ${err.message}`;
      loadStatus.textContent = `Erro ao vincular: ${err.message}`;
      loadDot.classList.remove("ok");
    } finally {
      btnAssignSave.disabled = false;
    }
  };

  document.getElementById("btnReload").onclick = async () => {
    await Promise.allSettled([loadFilterOptions(), loadHistory()]);
  };

  btnZoomIn.onclick = () => zoomHistoryChart(1.2);
  btnZoomOut.onclick = () => zoomHistoryChart(0.85);
  btnPanLeft.onclick = () => panHistoryChart(-120);
  btnPanRight.onclick = () => panHistoryChart(120);
  document.getElementById("btnResetZoom").onclick = () => {
    resetHistoryViewport();
    rebuildChart(table.getData());
  };

  document.getElementById("btnExportXlsx").onclick = () => {
    table.download("xlsx", "fieldlogger_historico.xlsx", { sheetName: "Historico" });
  };

  btnExportBatchSummary.onclick = async () => {
    await downloadBatchSummaryExport();
  };

  document.getElementById("btnCompareBatches").onclick = async () => {
    await runBatchCompare();
  };

  document.getElementById("btnClearFilters").onclick = async () => {
    selLote.value = "";
    selComposto.value = "";
    selBatch.value = "";
    rangeStart.value = "";
    rangeEnd.value = "";

    updatePeriodSummary();
    updateAssignActionVisibility();

    await Promise.allSettled([loadFilterOptions(), loadHistory()]);
  };

  btnManageCols.onclick = toggleColumnManager;
  btnShowAllCols.onclick = () => {
    hiddenColumnFields.clear();
    const columns = table.getColumns();
    for (const column of columns){
      const field = String(column.getField() || "");
      if (!field || field === "__row_actions") continue;
      table.showColumn(field);
    }
    rebuildColumnManager();
  };

  selBatch.addEventListener("change", async () => {
    updateAssignActionVisibility();
    await loadSelectedBatchDetails(normalizeBatchId(selBatch.value));
  });
  rangeStart.addEventListener("change", updatePeriodSummary);
  rangeEnd.addEventListener("change", updatePeriodSummary);
  rangeStart.addEventListener("input", updatePeriodSummary);
  rangeEnd.addEventListener("input", updatePeriodSummary);

  updatePeriodSummary();
  updateAssignActionVisibility();
  rebuildColumnManager();
  clearSelectedBatchCards("Selecione um batch para carregar metricas e energia acumulada.");
  setBatchEnergySeries([]);

  (async () => {
    await Promise.allSettled([loadFilterOptions(), loadHistory()]);
  })();
</script>
</body>
</html>


